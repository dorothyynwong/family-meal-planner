name: Development

on:
  push:
    branches: development

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: 1. Print environment variables
      run: printenv
    - uses: actions/checkout@v4
    
    - name: 2. Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    
    - name: 3. Restore backend dependencies
      run: dotnet restore backend/backend.csproj
      
    - name: 4. Build backend
      run:  dotnet build backend/backend.csproj
      
    - name: 5. Run backend tests
      env:  
        ImgBB_API_Key: ${{ secrets.ImgBB_API_Key }}
        DB_CONNECTION_STRING: ${{ secrets.DB_CONNECTION_STRING}}
      run: 
        dotnet test backend.Tests/backend.Tests.csproj
        
    - name: 6. Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: 7. Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_HUB_USER }}  
        password: ${{ secrets.DOCKER_HUB_PASSWORD }}  

    - name: 8. Build Docker image
      run: |
        IMAGE_TAG=${GITHUB_SHA::7}
        docker build -t ${{ secrets.DOCKER_HUB_USER }}/family-meal-planner-backend:${IMAGE_TAG} -f backend/DockerFile backend/
        echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
        
    - name: 9. Push Docker image
      run: |
        docker push ${{ secrets.DOCKER_HUB_USER }}/family-meal-planner-backend:${IMAGE_TAG}

    - name: 10. Trigger Render Deployment
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY_STAGING }}  
      run: |
        # Trigger deployment to Render
        curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK_STAGING }} \
        -H "Authorization: Bearer $RENDER_API_KEY" \
        -H "Content-Type: application/json" \
        -d '{"branch": "staging"}'  

    - name: 11. Navigate to backend folder
      run: cd backend  

    - name: 12. Setup .NET Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.x'  

    - name: 13. Install EF Core CLI
      run: dotnet tool install --global dotnet-ef

    - name: 14. Build the backend
      run: dotnet build --configuration Release

    - name: 15. Run EF Core Migrations
      env:
        ConnectionStrings_DefaultConnection: ${{ secrets.CONNECTION_STRINGS_STAGING }}
        SendGrid_Email: ${{ secrets.SENDGRID_EMAIL }}
        SendGrid_API_Key: ${{ secrets.SENDGRID_API_KEY }}
        OpenAI_API_Key: ${{ secrets.OPENAI_API_KEY }}
        ImgBB_API_Key: ${{ secrets.IMGBB_API_KEY }}
        JWT_Issuer: ${{ secrets.JWT_ISSUER }}
        JWT_Audience: ${{ secrets.JWT_AUDIENCE }}
        JWT_AppName: ${{ secrets.JWT_APPNAME }}
        JWT_RefreshTokenName: ${{ secrets.JWT_REFRESHTOKENNAME }}
        JWT_Secret: ${{ secrets.JWT_SECRET }}
      run: |
        dotnet ef database update --project backend/backend.csproj --context FamilyMealPlannerContext
